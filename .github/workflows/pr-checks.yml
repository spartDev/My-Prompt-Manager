name: ğŸ” Pull Request Checks

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  pull_request_target:
    types: [ opened, synchronize, reopened ]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18.x'
  # Fail fast - stop immediately on any quality gate failure
  CI: true

jobs:
  # Job 1: Setup dependencies and cache for all subsequent jobs
  setup:
    name: ğŸ“¦ Dependencies & Setup
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      node-version: ${{ env.NODE_VERSION }}
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better caching and analysis
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Cache Dependencies
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Verify Installation
        run: |
          npm ls --depth=0
          node --version
          npm --version

  # Job 2: Linting with zero tolerance policy
  lint:
    name: ğŸ§¹ Code Quality & Linting
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“‹ Cache ESLint Results
        uses: actions/cache@v3
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('.eslintrc.*', 'eslint.config.*', 'src/**/*.{ts,tsx}') }}

      - name: ğŸ§¹ Run ESLint (MANDATORY - ZERO TOLERANCE)
        run: |
          echo "ğŸš¨ MANDATORY: Running ESLint with zero tolerance policy"
          echo "âŒ Any linting errors will fail this check - NO EXCEPTIONS"
          npm run lint
        env:
          # Ensure ESLint failures cause workflow failure
          NODE_ENV: test

      - name: ğŸ“Š ESLint Report
        if: always()
        run: |
          echo "ğŸ“‹ ESLint Summary:"
          npx eslint . --format=compact --max-warnings=0 || echo "âš ï¸ Linting issues found above"

  # Job 3: Comprehensive testing with coverage
  test:
    name: ğŸ§ª Test Suite & Coverage
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    strategy:
      matrix:
        node-version: ['18.x', '20.x']
      fail-fast: true # Stop immediately on first failure
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª Run Test Suite (MANDATORY - ALL MUST PASS)
        run: |
          echo "ğŸš¨ MANDATORY: Running full test suite"
          echo "âŒ Any test failures will fail this check - NO EXCEPTIONS"
          npm test
        env:
          NODE_ENV: test
          CI: true

      - name: ğŸ“Š Generate Coverage Report
        if: matrix.node-version == '18.x'
        run: npm run test:coverage

      - name: ğŸ“ˆ Upload Coverage Reports
        if: matrix.node-version == '18.x'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

      - name: ğŸ“‹ Coverage Summary
        if: matrix.node-version == '18.x'
        run: |
          echo "ğŸ“Š Test Coverage Summary:"
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json
          fi

  # Job 4: Build verification for both dev and production
  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [setup, lint, test]
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“‹ Cache Build Assets
        uses: actions/cache@v3
        with:
          path: |
            dist
            .vite
          key: ${{ runner.os }}-build-${{ hashFiles('src/**/*', 'public/**/*', 'manifest.json') }}

      - name: ğŸ—ï¸ Production Build
        run: |
          echo "ğŸ—ï¸ Building Chrome extension for production..."
          npm run build
        env:
          NODE_ENV: production

      - name: ğŸ” Verify Build Output
        run: |
          echo "ğŸ” Verifying build artifacts..."
          ls -la dist/
          if [ ! -f "dist/manifest.json" ]; then
            echo "âŒ Missing manifest.json in build output"
            exit 1
          fi
          echo "âœ… Build verification passed"

      - name: ğŸ“¦ Chrome Extension Packaging
        run: |
          echo "ğŸ“¦ Testing Chrome extension packaging..."
          npm run package
        env:
          NODE_ENV: production

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: chrome-extension-build
          path: |
            dist/
            *.zip
          retention-days: 7

      - name: ğŸ“Š Build Size Analysis
        run: |
          echo "ğŸ“Š Build Size Analysis:"
          du -sh dist/
          find dist/ -name "*.js" -exec wc -c {} + | sort -n
          echo "ğŸ“¦ Extension package size:"
          ls -lh *.zip 2>/dev/null || echo "No zip files found"

  # Job 5: Security and dependency scanning
  security:
    name: ğŸ”’ Security & Dependencies
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ”’ Running npm security audit..."
          npm audit --audit-level=moderate
        continue-on-error: false # Fail on security vulnerabilities

      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

      - name: ğŸ“‹ Chrome Extension Manifest Validation
        run: |
          echo "ğŸ“‹ Validating Chrome extension manifest..."
          if [ ! -f "manifest.json" ]; then
            echo "âŒ Missing manifest.json"
            exit 1
          fi
          
          # Check for Manifest V3 compliance
          if ! grep -q '"manifest_version": 3' manifest.json; then
            echo "âš ï¸ Warning: Not using Manifest V3"
          else
            echo "âœ… Using Manifest V3"
          fi
          
          # Validate required fields
          required_fields=("name" "version" "description" "permissions")
          for field in "${required_fields[@]}"; do
            if ! grep -q "\"$field\"" manifest.json; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done
          
          echo "âœ… Manifest validation passed"

  # Job 6: Final quality gate summary
  quality-gate:
    name: âœ… Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [setup, lint, test, build, security]
    if: always() && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“‹ Quality Gate Results
        run: |
          echo "ğŸ“‹ Quality Gate Summary for PR #${{ github.event.pull_request.number }}"
          echo "=================================="
          
          # Check each job status
          setup_status="${{ needs.setup.result }}"
          lint_status="${{ needs.lint.result }}"
          test_status="${{ needs.test.result }}"
          build_status="${{ needs.build.result }}"
          security_status="${{ needs.security.result }}"
          
          echo "ğŸ“¦ Dependencies & Setup: $setup_status"
          echo "ğŸ§¹ Code Quality & Linting: $lint_status"
          echo "ğŸ§ª Test Suite & Coverage: $test_status"
          echo "ğŸ—ï¸ Build Verification: $build_status"
          echo "ğŸ”’ Security & Dependencies: $security_status"
          
          # Determine overall status
          if [[ "$setup_status" == "success" && "$lint_status" == "success" && "$test_status" == "success" && "$build_status" == "success" && "$security_status" == "success" ]]; then
            echo ""
            echo "ğŸ‰ âœ… ALL QUALITY GATES PASSED!"
            echo "ğŸš€ This PR meets all mandatory requirements and is ready for review."
          else
            echo ""
            echo "âŒ ğŸš¨ QUALITY GATES FAILED!"
            echo "ğŸ›‘ This PR does not meet the mandatory requirements."
            echo "ğŸ“‹ Please fix all issues before requesting review."
            exit 1
          fi

      - name: ğŸ“Š Add PR Comment with Results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              setup: "${{ needs.setup.result }}",
              lint: "${{ needs.lint.result }}",
              test: "${{ needs.test.result }}",
              build: "${{ needs.build.result }}",
              security: "${{ needs.security.result }}"
            };
            
            const allPassed = Object.values(results).every(result => result === 'success');
            const status = allPassed ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = allPassed ? 'ğŸ‰' : 'ğŸš¨';
            
            const comment = `## ${emoji} Quality Gate Results ${status}
            
            | Check | Status |
            |-------|---------|
            | ğŸ“¦ Dependencies & Setup | ${results.setup === 'success' ? 'âœ…' : 'âŒ'} ${results.setup} |
            | ğŸ§¹ Code Quality & Linting | ${results.lint === 'success' ? 'âœ…' : 'âŒ'} ${results.lint} |
            | ğŸ§ª Test Suite & Coverage | ${results.test === 'success' ? 'âœ…' : 'âŒ'} ${results.test} |
            | ğŸ—ï¸ Build Verification | ${results.build === 'success' ? 'âœ…' : 'âŒ'} ${results.build} |
            | ğŸ”’ Security & Dependencies | ${results.security === 'success' ? 'âœ…' : 'âŒ'} ${results.security} |
            
            ${allPassed 
              ? 'ğŸš€ **All mandatory quality requirements have been met!** This PR is ready for review.' 
              : 'ğŸ›‘ **Quality gates failed.** Please address all issues before requesting review.'}
            
            ---
            
            ### ğŸš¨ Mandatory Requirements Enforced:
            - âœ… **Zero tolerance** for linting errors (\`npm run lint\`)
            - âœ… **All tests must pass** (\`npm test\`)
            - âœ… **Build must succeed** for Chrome extension
            - âœ… **No security vulnerabilities** above moderate level
            - âœ… **Manifest V3 compliance** for Chrome extension
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });