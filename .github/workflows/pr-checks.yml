name: ğŸ” Pull Request Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22.x"
  # Fail fast - stop immediately on any quality gate failure
  CI: true

jobs:
  # Job 1: Setup dependencies and cache for all subsequent jobs
  setup:
    name: ğŸ“¦ Dependencies & Setup
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      node-version: ${{ env.NODE_VERSION }}
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          # Fetch full history for better caching and analysis
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Cache Dependencies
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Verify Installation
        run: |
          npm ls --depth=0
          node --version
          npm --version

  # Job 2: Type checking
  type-check:
    name: "ğŸ“˜ TypeScript Type Checking"
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    steps:
      - name: "ğŸ›ï¸ Checkout Repository"
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: "ğŸŸ¢ Setup Node.js"
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "npm"

      - name: "ğŸ“¦ Restore Dependencies"
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: "ğŸ”§ Install Dependencies"
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: "ğŸ“˜ TypeScript Type Check"
        run: |
          echo "ğŸš¨ MANDATORY: Running TypeScript strict type checking"
          npm run typecheck
          echo "âœ… All types are correct"

      - name: "ğŸ“‹ Type Coverage Report"
        if: always()
        run: |
          echo "ğŸ“Š TypeScript Configuration:"
          node -e "
            const { compilerOptions } = require('./tsconfig.json');
            const strictOptions = {
              strict: compilerOptions.strict,
              noImplicitAny: compilerOptions.noImplicitAny,
              noUnusedLocals: compilerOptions.noUnusedLocals,
              noUnusedParameters: compilerOptions.noUnusedParameters,
              noFallthroughCasesInSwitch: compilerOptions.noFallthroughCasesInSwitch
            };
            console.log(JSON.stringify(strictOptions, null, 2));
          "

  # Job 3: Linting with zero tolerance policy
  lint:
    name: ğŸ§¹ Code Quality & Linting
    runs-on: ubuntu-latest
    needs: [setup, type-check]
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“‹ Cache ESLint Results
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('.eslintrc.*', 'eslint.config.*', 'src/**/*.{ts,tsx}') }}

      - name: ğŸ§¹ Run ESLint (MANDATORY - ZERO TOLERANCE)
        run: |
          echo "ğŸš¨ MANDATORY: Running ESLint with zero tolerance policy"
          echo "âŒ Any linting errors will fail this check - NO EXCEPTIONS"
          npm run lint
        env:
          # Ensure ESLint failures cause workflow failure
          NODE_ENV: test

      - name: ğŸ“Š ESLint Report
        if: always()
        run: |
          echo "ğŸ“‹ ESLint Summary:"
          npx eslint . --format=compact --max-warnings=0 || echo "âš ï¸ Linting issues found above"

  # Job 4: Comprehensive testing with coverage
  test:
    name: ğŸ§ª Test Suite & Coverage
    runs-on: ubuntu-latest
    needs: [setup, type-check]
    if: github.event.pull_request.draft == false
    strategy:
      matrix:
        node-version: ["22.x", "24.x"]
      fail-fast: true # Stop immediately on first failure
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª Run Test Suite (MANDATORY - ALL MUST PASS)
        run: |
          echo "ğŸš¨ MANDATORY: Running full test suite"
          echo "âŒ Any test failures will fail this check - NO EXCEPTIONS"
          npm test
        env:
          NODE_ENV: test
          CI: true

      - name: ğŸ“Š Generate Coverage Report
        if: matrix.node-version == '22.x'
        run: npm run test:coverage

      - name: ğŸ“ˆ Upload Coverage Reports
        if: matrix.node-version == '22.x'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

      - name: ğŸ“‹ Coverage Summary
        if: matrix.node-version == '22.x'
        run: |
          echo "ğŸ“Š Test Coverage Summary:"
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json
          fi

  # Job 5: Build verification for both dev and production
  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [setup, type-check, lint, test]
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“‹ Cache Build Assets
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            dist
            .vite
          key: ${{ runner.os }}-build-${{ hashFiles('src/**/*', 'public/**/*', 'manifest.json') }}

      - name: ğŸ—ï¸ Production Build
        run: |
          echo "ğŸ—ï¸ Building Chrome extension for production..."
          npm run build
        env:
          NODE_ENV: production

      - name: ğŸ” Verify Build Output
        run: |
          echo "ğŸ” Verifying build artifacts..."
          ls -la dist/
          if [ ! -f "dist/manifest.json" ]; then
            echo "âŒ Missing manifest.json in build output"
            exit 1
          fi
          echo "âœ… Build verification passed"

      - name: ğŸ“¦ Chrome Extension Packaging
        run: |
          echo "ğŸ“¦ Testing Chrome extension packaging..."
          npm run package

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: chrome-extension-build
          path: |
            dist/
            *.zip
          retention-days: 7

      - name: ğŸ“Š Build Size Analysis
        run: |
          echo "ğŸ“Š Build Size Analysis:"
          du -sh dist/
          find dist/ -name "*.js" -exec wc -c {} + | sort -n
          echo "ğŸ“¦ Extension package size:"
          ls -lh *.zip 2>/dev/null || echo "No zip files found"

  # Job 6: End-to-end regression suite with Playwright
  e2e:
    name: ğŸ¯ End-to-End Tests
    runs-on: ubuntu-latest
    needs: [setup, type-check, lint, test]
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“¥ Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ğŸ¯ Install Playwright Chromium
        run: npx playwright install --with-deps chromium
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "false"

      - name: ğŸ§ª Run Playwright E2E Suite
        run: npm run test:e2e
        env:
          CI: true
          PLAYWRIGHT_WORKERS: "4"

      - name: ğŸ“¤ Upload Playwright Report (on failure)
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # Job 7: Security and dependency scanning
  security:
    name: ğŸ”’ Security & Dependencies
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ”§ Install Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ”’ Running npm security audit..."
          npm audit --audit-level=moderate
        continue-on-error: false # Fail on security vulnerabilities

      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4
        with:
          fail-on-severity: moderate
          # DOMPurify is dual-licensed (Apache-2.0 OR MPL-2.0) but npm metadata includes GPL-2.0-only
          # We use the Apache-2.0 option. Adding GPL-2.0-only acknowledges it's in the SPDX expression.
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0, GPL-2.0-only

      - name: ğŸ“‹ Chrome Extension Manifest Validation
        run: |
          echo "ğŸ“‹ Validating Chrome extension manifest..."
          if [ ! -f "manifest.json" ]; then
            echo "âŒ Missing manifest.json"
            exit 1
          fi

          # Check for Manifest V3 compliance
          if ! grep -q '"manifest_version": 3' manifest.json; then
            echo "âš ï¸ Warning: Not using Manifest V3"
          else
            echo "âœ… Using Manifest V3"
          fi

          # Validate required fields
          required_fields=("name" "version" "description" "permissions")
          for field in "${required_fields[@]}"; do
            if ! grep -q "\"$field\"" manifest.json; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done

          echo "âœ… Manifest validation passed"

  # Job 8: Final quality gate summary
  quality-gate:
    name: âœ… Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [setup, type-check, lint, test, build, e2e, security]
    # Run even if jobs are cancelled or fail, but not for draft PRs
    if: always() && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“‹ Quality Gate Results
        run: |
          echo "ğŸ“‹ Quality Gate Summary for PR #${{ github.event.pull_request.number }}"
          echo "=================================="

          # Check each job status
          setup_status="${{ needs.setup.result }}"
          lint_status="${{ needs.lint.result }}"
          test_status="${{ needs.test.result }}"
          build_status="${{ needs.build.result }}"
          e2e_status="${{ needs.e2e.result }}"
          security_status="${{ needs.security.result }}"

          echo "ğŸ“¦ Dependencies & Setup: $setup_status"
          echo "ğŸ§¹ Code Quality & Linting: $lint_status"
          echo "ğŸ§ª Test Suite & Coverage: $test_status"
          echo "ğŸ—ï¸ Build Verification: $build_status"
          echo "ğŸ¯ End-to-End Tests: $e2e_status"
          echo "ğŸ”’ Security & Dependencies: $security_status"

          # Check if workflow was cancelled (new commit pushed)
          if [[ "$setup_status" == "cancelled" || "$lint_status" == "cancelled" || "$test_status" == "cancelled" || "$build_status" == "cancelled" || "$e2e_status" == "cancelled" || "$security_status" == "cancelled" ]]; then
            echo ""
            echo "âš ï¸ WORKFLOW CANCELLED"
            echo "A new commit was pushed, cancelling this workflow run."
            echo "The latest commit will be checked in a new workflow run."
            # Don't fail on cancelled - it's expected behavior
            exit 0
          # Check if all succeeded
          elif [[ "$setup_status" == "success" && "$lint_status" == "success" && "$test_status" == "success" && "$build_status" == "success" && "$e2e_status" == "success" && "$security_status" == "success" ]]; then
            echo ""
            echo "ğŸ‰ âœ… ALL QUALITY GATES PASSED!"
            echo "ğŸš€ This PR meets all mandatory requirements and is ready for review."
            exit 0
          else
            echo ""
            echo "âŒ ğŸš¨ QUALITY GATES FAILED!"
            echo "ğŸ›‘ This PR does not meet the mandatory requirements."
            echo "ğŸ“‹ Please fix all issues before requesting review."
            exit 1
          fi

      - name: ğŸ“Š Add PR Comment with Results
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const results = {
              setup: "${{ needs.setup.result }}",
              lint: "${{ needs.lint.result }}",
              test: "${{ needs.test.result }}",
              build: "${{ needs.build.result }}",
              e2e: "${{ needs.e2e.result }}",
              security: "${{ needs.security.result }}"
            };

            // Check workflow status
            const anyCancelled = Object.values(results).some(result => result === 'cancelled');
            const allPassed = Object.values(results).every(result => result === 'success');
            const allSkipped = Object.values(results).every(result => result === 'skipped');

            // Skip comment for cancelled workflows - they're superseded by new commits
            if (anyCancelled) {
              console.log('Workflow cancelled - skipping comment to reduce noise');
              return;
            }

            // Skip comment for fully skipped workflows (e.g., draft PRs)
            if (allSkipped) {
              console.log('All checks skipped - no comment needed');
              return;
            }

            // Determine status for meaningful results only
            let status, emoji, message;

            if (allPassed) {
              status = 'âœ… PASSED';
              emoji = 'ğŸ‰';
              message = 'ğŸš€ **All mandatory quality requirements have been met!** This PR is ready for review.';
            } else {
              status = 'âŒ FAILED';
              emoji = 'ğŸš¨';
              message = 'ğŸ›‘ **Quality gates failed.** Please address all issues before requesting review.';
            }

            // Helper function to get status icon
            const getStatusIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âš ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            // Find and delete previous bot comments to keep PR clean
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComments = comments.filter(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Quality Gate Results')
            );

            // Delete old quality gate comments (keep only the latest)
            for (const comment of botComments) {
              try {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                });
                console.log(`Deleted old quality gate comment ${comment.id}`);
              } catch (error) {
                console.log(`Could not delete comment ${comment.id}: ${error.message}`);
              }
            }

            // Create the new comment with meaningful results
            const comment = `## ${emoji} Quality Gate Results ${status}

            **Commit:** \`${context.sha.substring(0, 7)}\` | **Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            | Check | Status |
            |-------|---------|
            | ğŸ“¦ Dependencies & Setup | ${getStatusIcon(results.setup)} ${results.setup} |
            | ğŸ§¹ Code Quality & Linting | ${getStatusIcon(results.lint)} ${results.lint} |
            | ğŸ§ª Test Suite & Coverage | ${getStatusIcon(results.test)} ${results.test} |
            | ğŸ—ï¸ Build Verification | ${getStatusIcon(results.build)} ${results.build} |
            | ğŸ¯ End-to-End Tests | ${getStatusIcon(results.e2e)} ${results.e2e} |
            | ğŸ”’ Security & Dependencies | ${getStatusIcon(results.security)} ${results.security} |

            ${message}

            ---

            ### ğŸ“‹ Mandatory Requirements:
            - âœ… **Zero tolerance** for linting errors (\`npm run lint\`)
            - âœ… **All tests must pass** (\`npm test\`)
            - âœ… **Build must succeed** for Chrome extension
            - âœ… **Playwright end-to-end suite** must pass (\`npm run test:e2e\`)
            - âœ… **No security vulnerabilities** above moderate level
            - âœ… **Manifest V3 compliance** for Chrome extension

            <sub>ğŸ’¡ This comment updates automatically with each workflow run. Previous results are replaced to keep the PR clean.</sub>
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
